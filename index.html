<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الخرائط التفاعلية</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Cairo Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* ألوان الوضع الفاتح */
            --main-bg: #f0f2f5;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --panel-border: rgba(0, 0, 0, 0.1);
            --text-color: #333;
            --text-secondary: #666;
            --accent-color: #4a6fa5;
            --accent-hover: #3d5d8a;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --button-bg: #fff;
            --button-text: #333;
            --map-control-bg: rgba(255, 255, 255, 0.9);
            --highlight: #ff6b6b;
            --success: #4caf50;
            
            /* ألوان المضلعات */
            --polygon-color: rgba(255, 0, 0, 0.5);
        }
        
        .dark-mode {
            /* ألوان الوضع الداكن */
            --main-bg: #121212;
            --panel-bg: rgba(30, 30, 30, 0.85);
            --panel-border: rgba(255, 255, 255, 0.1);
            --text-color: #f0f0f0;
            --text-secondary: #aaa;
            --accent-color: #5d8fc9;
            --accent-hover: #4a74a5;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --button-bg: #2a2a2a;
            --button-text: #f0f0f0;
            --map-control-bg: rgba(40, 40, 40, 0.9);
            --highlight: #ff8e8e;
            --success: #66bb6a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background-color: var(--main-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* تصميم الخريطة */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }
        
        /* اللوحات الجانبية */
        .panel {
            position: absolute;
            top: 0;
            height: 100%;
            width: 20rem;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: var(--shadow);
            border: 1px solid var(--panel-border);
            transition: transform 0.3s ease;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .left-panel {
            right: 0;
        }
        
        .panel-hidden {
            transform: translateX(100%);
        }
        
        /* عناوين اللوحات */
        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* أزرار التحكم */
        .toggle-btn {
            position: absolute;
            top: 1rem;
            z-index: 1001;
            background: var(--map-control-bg);
            border: 1px solid var(--panel-border);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            font-size: 1.2rem;
        }
        
        .toggle-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }
        
        .toggle-left {
            right: 1rem;
        }
        
        /* عناصر التحكم في الخريطة المخصصة */
        .custom-controls {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .custom-control {
            background: var(--map-control-bg);
            border: 1px solid var(--panel-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            font-size: 1.1rem;
        }
        
        .custom-control:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }
        
        /* صندوق المساحة الحالية */
        #current-area-box {
            position: absolute;
            bottom: 4rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            border: 1px solid var(--panel-border);
            display: none;
            min-width: 250px;
        }
        
        .area-info {
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .area-info h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .area-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .area-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: var(--button-bg);
            color: var(--button-text);
            transition: background 0.2s;
        }
        
        .save-btn {
            background: var(--success);
            color: white;
        }
        
        .cancel-btn {
            background: #f44336;
            color: white;
        }
        
        /* عناصر القائمة */
        .panel-item {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }
        
        .panel-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--accent-color);
        }
        
        .panel-item-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-item-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        
        .item-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .action-btn {
            padding: 0.25rem 0.5rem;
            background: var(--button-bg);
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: var(--accent-color);
            color: white;
        }
        
        /* أزرار القائمة الدائرية */
        .tools-menu {
            position: absolute;
            top: 5rem;
            left: 1rem;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .tool-btn {
            background: var(--map-control-bg);
            border: 1px solid var(--panel-border);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            font-size: 1.2rem;
            overflow: hidden;
        }
        
        .tool-btn img {
            width: 24px;
            height: 24px;
        }
        
        .tool-btn:hover {
            background: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }
        
        .tool-btn.active {
            background: var(--accent-color);
            color: white;
        }
        
        /* شريط البحث */
        .search-container {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .search-toggle {
            background: var(--map-control-bg);
            border: 1px solid var(--panel-border);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            font-size: 1.2rem;
        }
        
        .search-toggle:hover {
            background: var(--accent-color);
            color: white;
        }
        
        .search-box {
            position: relative;
            width: 0;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateX(20px);
        }
        
        .search-box.active {
            width: 300px;
            opacity: 1;
            transform: translateX(0);
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 0.75rem;
            border: 1px solid var(--panel-border);
            border-radius: 30px;
            background: var(--button-bg);
            color: var(--text-color);
            box-shadow: var(--shadow);
        }
        
        .search-icon {
            position: absolute;
            top: 50%;
            left: 0.75rem;
            transform: translateY(-50%);
        }
        
        /* التصميم المتجاوب */
        @media (max-width: 900px) {
            .panel {
                width: 18rem;
            }
            
            .toggle-btn {
                top: 0.5rem;
            }
            
            .toggle-left {
                right: 0.5rem;
            }
        }
        
        @media (max-width: 600px) {
            .panel {
                width: 16rem;
                padding: 0.75rem;
            }
            
            .custom-controls {
                bottom: 0.5rem;
            }
            
            .search-box.active {
                width: 250px;
            }
        }
        
        /* الرسائل والتنبيهات */
        .no-selections {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
        }
        
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 2000;
            animation: fadeIn 0.3s;
        }
        
        .alert-info {
            background-color: var(--accent-color);
            color: white;
        }
        
        .alert-error {
            background-color: #f44336;
            color: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; top: 10px; }
            to { opacity: 1; top: 20px; }
        }
        
        /* النصوص على الخريطة */
        .map-label {
            background: var(--panel-bg);
            backdrop-filter: blur(5px);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--panel-border);
            font-weight: bold;
            cursor: move;
            user-select: none;
        }
        
        /* منبثق التعديل */
        .edit-popup {
            position: absolute;
            bottom: 8rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            border: 1px solid var(--panel-border);
            display: none;
            min-width: 250px;
            text-align: center;
        }
        
        .edit-popup h3 {
            margin-bottom: 1rem;
        }
        
        .edit-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .edit-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius:  4px;
            cursor: pointer;
            background: var(--button-bg);
            color: var(--button-text);
            transition: background 0.2s;
        }
        
        .confirm-btn {
            background: var(--success);
            color: white;
        }
        
        .revert-btn {
            background: #f44336;
            color: white;
        }
        
        /* منبثق البحث */
        #search-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--panel-border);
            min-width: 300px;
            text-align: center;
            display: none;
        }
        
        #search-modal h3 {
            margin-bottom: 1rem;
            color: var(--accent-color);
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .modal-add-btn {
            background: var(--success);
            color: white;
        }
        
        .modal-cancel-btn {
            background: #f44336;
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        /* المسطرة */
        .leaflet-control-scale {
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: var(--map-control-bg);
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            box-shadow: var(--shadow);
        }
        
        /* عناصر التحكم في الشفافية والنمط */
        .style-control {
            margin-top: 0.5rem;
        }
        
        .style-control label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }
        
        .opacity-slider {
            width: 100%;
            margin-top: 0.25rem;
        }
        
        .pattern-select {
            width: 100%;
            padding: 0.25rem;
            border-radius: 4px;
            border: 1px solid var(--panel-border);
            background: var(--button-bg);
            color: var(--text-color);
        }
        
        /* تعديلات للوضع الداكن */
        .dark-mode .leaflet-control-scale {
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <!-- الخريطة -->
    <div id="map"></div>
    
    <!-- اللوحة اليسرى (التحديدات الحالية) -->
    <div class="panel left-panel">
        <div class="panel-title">
            <span>التحديدات الحالية</span>
            <i class="fas fa-times close-panel"></i>
        </div>
        <div id="current-selections">
            <div class="no-selections">لا توجد تحديدات حتى الآن</div>
        </div>
    </div>
    
    <!-- شريط البحث -->
    <div class="search-container">
        <div class="search-toggle" id="search-toggle">
            <i class="fas fa-search"></i>
        </div>
        <div class="search-box" id="search-box">
            <input type="text" id="search-input" class="search-input" placeholder="ابحث عن موقع...">
            <i class="fas fa-search search-icon"></i>
        </div>
    </div>
    
    <!-- منبثق البحث -->
    <div id="search-modal">
        <h3 id="modal-city-name">تم العثور على المدينة</h3>
        <p>هل ترغب في إضافة المدينة إلى التحديدات؟</p>
        <div class="modal-actions">
            <button class="modal-btn modal-add-btn" id="add-city-btn">إضافة المدينة</button>
            <button class="modal-btn modal-cancel-btn" id="cancel-city-btn">إلغاء</button>
        </div>
    </div>
    
    <!-- قائمة الأدوات الدائرية -->
    <div class="tools-menu">
        
        <div class="tool-btn" id="polygon-btn" title="تحديد مضلع">
            <i class="fas fa-draw-polygon"></i>
        </div>
        <div class="tool-btn" id="add-text-btn" title="إضافة نص">
            <i class="fas fa-font"></i>
        </div>
        <div class="tool-btn" id="fire-btn" title="نار تشتعل">
            <img src="ملصقات/دبابة.png" alt="نار">
        </div>
        <div class="tool-btn" id="soldier-btn" title="جندي يطرق النار">
            <img src="ملصقات/جنود.png" alt="جندي">
        </div>
        <div class="tool-btn" id="airplane-btn" title="طيارة تطير">
            <img src="ملصقات/طيارة.png" alt="طائرة">
        </div>
        <div class="tool-btn" id="delete-all-btn" title="حذف التحديدات">
            <i class="fas fa-trash"></i>
        </div>
        <div class="tool-btn" id="theme-toggle" title="تغيير الثيم">
            <i class="fas fa-moon"></i>
        </div>
    </div>
    
    <!-- زر التحكم في اللوحة الجانبية -->
    <div class="toggle-btn toggle-left">
        <i class="fas fa-layer-group"></i>
    </div>
    
    <!-- صندوق المساحة الحالية -->
    <div id="current-area-box">
        <div class="area-info">
            <h3>المساحة الحالية</h3>
            <p id="area-value">0 م² (0 كم²)</p>
        </div>
        <div class="area-actions">
            <button class="area-btn save-btn" id="save-area">إضافة التحديد</button>
            <button class="area-btn cancel-btn" id="cancel-area">حذف التحديد</button>
        </div>
    </div>
    
    <!-- منبثق التعديل -->
    <div class="edit-popup" id="edit-popup">
        <h3>هل تريد حفظ التعديلات؟</h3>
        <div class="edit-actions">
            <button class="edit-btn confirm-btn" id="confirm-edit">تم</button>
            <button class="edit-btn revert-btn" id="revert-edit">إلغاء</button>
        </div>
    </div>
    
    <!-- مكتبات JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.browser.print@1.0.1/dist/leaflet.browser.print.min.js"></script>
    
    <!-- ملف GeoJSON -->
    <link rel="preload" href="data/cities.geojson" as="fetch" crossorigin>
    
    <script>
        // تهيئة المتغيرات
        let map, currentLayer, drawingMode = null;
        let markers = [];
        let polygons = [];
        let labels = [];
        let icons = [];
        let currentAreaBox = document.getElementById('current-area-box');
        let areaValue = document.getElementById('area-value');
        let selectionCounter = 1;
        let editMode = false;
        let currentEditPolygon = null;
        let originalPolygon = null;
        let editPopup = document.getElementById('edit-popup');
        let currentColor = '#ff0000';
        let nameLabels = {};
        let geoJsonData = null;
        let lastSearchPolygon = null;
        let lastSearchLabel = null;
        let currentSearchResult = null;
        
        // تهيئة الخريطة
        function initMap() {
            // إنشاء الخريطة
            map = L.map('map', {
                center: [35.9306, 36.6339],
                zoom: 13,
                zoomControl: false
            });
            
            // إضافة طبقات الخريطة
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });
            
            // طبقة ساتلية مع أسماء المدن والحدود
            const satelliteWithLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });
            
            // طبقة حدود ومدن
            const boundariesLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });
            
            // مجموعة طبقات للخريطة الساتلية مع الحدود
            const satelliteGroup = L.layerGroup([satelliteWithLabels, boundariesLayer]);
            
            // إضافة الطبقات إلى الخريطة
            osmLayer.addTo(map);
            
            // إضافة عناصر تحكم الطبقة
            const baseLayers = {
                "خريطة طرقية": osmLayer,
                "خريطة ساتلية": satelliteGroup
            };
            
            L.control.layers(baseLayers, null, {position: 'bottomright'}).addTo(map);
            
            // إضافة مسطرة المسافة
            L.control.scale({position: 'bottomleft'}).addTo(map);
            
            // تهيئة الأحداث
            initEvents();
            
            // تحديث الوضع الداكن بناءً على تفضيلات المستخدم
            updateThemeBasedOnPreference();
            
            // تحميل بيانات GeoJSON
            loadGeoJSON();
        }
        
       
        // تهيئة الأحداث
        function initEvents() {
            // أحداث أزرار التحكم في اللوحات
            const toggleLeft = document.querySelector('.toggle-left');
            toggleLeft.addEventListener('click', () => {
                document.querySelector('.left-panel').classList.toggle('panel-hidden');
            });
            
            // أحداث إغلاق اللوحة الجانبية
            const closePanel = document.querySelector('.close-panel');
            closePanel.addEventListener('click', () => {
                document.querySelector('.left-panel').classList.add('panel-hidden');
            });
            
            // أحداث أزرار الأدوات
            document.getElementById('polygon-btn').addEventListener('click', () => startDrawing('polygon'));
            document.getElementById('add-text-btn').addEventListener('click', addText);
            document.getElementById('fire-btn').addEventListener('click', () => addIcon('fire'));
            document.getElementById('soldier-btn').addEventListener('click', () => addIcon('soldier'));
            document.getElementById('airplane-btn').addEventListener('click', () => addIcon('airplane'));
            document.getElementById('delete-all-btn').addEventListener('click', deleteAllItems);
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // أحداث البحث
            const searchToggle = document.getElementById('search-toggle');
            const searchInput = document.getElementById('search-input');
            searchToggle.addEventListener('click', toggleSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation(this.value);
                }
            });
            
            // أحداث حفظ وحذف المساحة
            document.getElementById('save-area').addEventListener('click', saveSelection);
            document.getElementById('cancel-area').addEventListener('click', resetDrawing);
            
            // أحداث منبثق التعديل
            document.getElementById('confirm-edit').addEventListener('click', confirmEdit);
            document.getElementById('revert-edit').addEventListener('click', revertEdit);
            
            // أحداث منبثق البحث
            document.getElementById('add-city-btn').addEventListener('click', addSearchResultToSelections);
            document.getElementById('cancel-city-btn').addEventListener('click', cancelSearchResult);
        }
        
        // تبديل شريط البحث
        function toggleSearch() {
            const searchBox = document.getElementById('search-box');
            searchBox.classList.toggle('active');
            
            if (searchBox.classList.contains('active')) {
                document.getElementById('search-input').focus();
            }
        }
        
        // بدء عملية الرسم
        function startDrawing(type) {
            // إيقاف أي وضع رسم سابق
            resetDrawing();
            
            // الخروج من وضع التحرير إذا كان نشطًا
            if (editMode) {
                exitEditMode();
            }
            
            drawingMode = type;
            
            // إظهار صندوق المساحة
            currentAreaBox.style.display = 'block';
            
            // إضافة مستمع حدث للنقر على الخريطة
            map.on('click', handleMapClick);
        }
        
        // معالجة النقر على الخريطة أثناء الرسم
        function handleMapClick(e) {
            addMarker(e.latlng);
        }
        
        // إضافة علامة إلى الخريطة
        function addMarker(latlng) {
            const marker = L.marker(latlng, {
                draggable: true
            }).addTo(map);
            
            markers.push(marker);
            
            // تحديث المضلع/المنحنى عند سحب العلامة
            marker.on('drag', updateShape);
            marker.on('dragend', updateShape);
            
            // إذا كان هناك علامتان أو أكثر، قم بإنشاء/تحديث المضلع
            if (markers.length >= 2) {
                updateShape();
            }
            
            // إذا كان هناك ثلاث علامات أو أكثر، احسب المساحة
            if (markers.length >= 3) {
                calculateArea();
            }
        }
        
        // تحديث الشكل المرسوم
        function updateShape() {
            // إزالة المضلع/المنحنى السابق إذا كان موجودًا
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            
            // إنشاء مجموعة الإحداثيات من العلامات
            const latlngs = markers.map(marker => marker.getLatLng());
            
            // إنشاء المضلع
            if (drawingMode === 'polygon') {
                currentLayer = L.polygon(latlngs, {
                    color: currentColor,
                    fillOpacity: 0.5,
                    weight: 2
                }).addTo(map);
            }
            
            // إذا كان هناك ثلاث علامات أو أكثر، احسب المساحة
            if (markers.length >= 3 && drawingMode === 'polygon') {
                calculateArea();
            }
        }
        
        // حساب المساحة
        function calculateArea() {
            if (drawingMode !== 'polygon' || markers.length < 3) return;
            
            try {
                // إنشاء مضلع من إحداثيات العلامات
                const latlngs = markers.map(marker => marker.getLatLng());
                
                // تحويل الإحداثيات إلى [lng, lat] لـ Turf.js
                const coords = latlngs.map(latlng => [latlng.lng, latlng.lat]);
                // إغلاق المضلع
                if (coords[0][0] !== coords[coords.length - 1][0] || coords[0][1] !== coords[coords.length - 1][1]) {
                    coords.push(coords[0]);
                }
                const polygon = turf.polygon([coords]);
                
                // حساب المساحة بالمتر المربع
                const area = turf.area(polygon);
                
                // تحويل المساحة إلى كيلومتر مربع
                const areaKm = area / 1000000;
                
                // تحديث عرض المساحة
                areaValue.textContent = `${area.toFixed(2)} م² (${areaKm.toFixed(6)} كم²)`;
            } catch (error) {
                console.error('خطأ في حساب المساحة:', error);
                areaValue.textContent = 'خطأ في الحساب';
                showAlert('حدث خطأ أثناء حساب المساحة', 'error');
            }
        }
        
        // حفظ التحديد
        function saveSelection() {
            if (!currentLayer || (drawingMode === 'polygon' && markers.length < 3)) {
                showAlert('يجب إنشاء مضلع مكون من 3 نقاط على الأقل', 'error');
                return;
            }
            
            // إخفاء الدبابيس
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // إعطاء معرف فريد للمضلع
            currentLayer._id = `polygon-${Date.now()}`;
            
            // حفظ المضلع
            polygons.push(currentLayer);
            
            // إضافة التحديد إلى اللوحة
            addToCurrentSelections();
            
            // إعادة تعيين عملية الرسم
            resetDrawing();
        }
        
        // إضافة عنصر إلى التحديدات الحالية
        function addToCurrentSelections() {
            const container = document.getElementById('current-selections');
            const noSelections = container.querySelector('.no-selections');
            
            if (noSelections) {
                noSelections.remove();
            }
            
            const item = document.createElement('div');
            item.className = 'panel-item';
            item.dataset.id = currentLayer._id;
            
            // إنشاء لون عشوائي
            const color = getRandomColor();
            currentColor = color;
            
            item.innerHTML = `
                <div class="panel-item-title">
                    <input type="text" value="تحديد ${selectionCounter}" class="selection-name">
                    <input type="color" class="shape-color" value="${color}">
                </div>
                
                <div class="panel-item-content">
                    <div class="selection-option">
                        <input type="checkbox" id="show-name-${currentLayer._id}" class="show-name">
                        <label for="show-name-${currentLayer._id}">إظهار الاسم على الخريطة</label>
                    </div>
                    
                    <div class="style-control">
                        <label>الشفافية:</label>
                        <input type="range" min="0" max="1" step="0.1" class="opacity-slider" value="0.5">
                    </div>
                    
                    <div class="style-control">
                        <label>نمط التعبئة:</label>
                        <select class="pattern-select">
                            <option value="none">بدون</option>
                            <option value="cross">خطوط متقاطعة</option>
                            <option value="diagonal">خطوط مائلة</option>
                            <option value="checker">رقعة شطرنج</option>
                        </select>
                    </div>
                    
                    <div class="selection-info">
                        <p><strong>المساحة:</strong> ${areaValue.textContent}</p>
                        <p><strong>النقاط:</strong> ${markers.length}</p>
                    </div>
                </div>
                
                <div class="item-actions">
                    <button class="action-btn edit-btn" data-id="${currentLayer._id}">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button class="action-btn delete-btn" data-id="${currentLayer._id}">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
            `;
            
            container.appendChild(item);
            
            // تحديث لون التحديد
            currentLayer.setStyle({fillColor: color, color: color});
            
            // إضافة أحداث للأزرار
            const editBtn = item.querySelector('.edit-btn');
            const deleteBtn = item.querySelector('.delete-btn');
            editBtn.addEventListener('click', () => editSelection(editBtn.dataset.id));
            deleteBtn.addEventListener('click', () => deleteSelection(deleteBtn.dataset.id));
            
            // إضافة حدث لتغيير اللون
            const colorInput = item.querySelector('.shape-color');
            colorInput.addEventListener('input', function() {
                const polygon = polygons.find(p => p._id === item.dataset.id);
                if (polygon) {
                    polygon.setStyle({fillColor: this.value, color: this.value});
                }
            });
            
            // إضافة حدث لتغيير الشفافية
            const opacitySlider = item.querySelector('.opacity-slider');
            opacitySlider.addEventListener('input', function() {
                const polygon = polygons.find(p => p._id === item.dataset.id);
                if (polygon) {
                    polygon.setStyle({fillOpacity: this.value});
                }
            });
            
            // إضافة حدث لتغيير نمط التعبئة
            const patternSelect = item.querySelector('.pattern-select');
            patternSelect.addEventListener('change', function() {
                console.log(`نمط التعبئة المختار: ${this.value}`);
            });
            
            // إضافة حدث لإظهار الاسم
            const nameCheckbox = item.querySelector('.show-name');
            nameCheckbox.addEventListener('change', function() {
                const polygon = polygons.find(p => p._id === item.dataset.id);
                const nameInput = item.querySelector('.selection-name');
                
                if (this.checked) {
                    // إزالة التسمية القديمة إذا كانت موجودة
                    if (nameLabels[item.dataset.id]) {
                        map.removeLayer(nameLabels[item.dataset.id]);
                    }
                    
                    // إضافة الاسم على الخريطة
                    const center = polygon.getBounds().getCenter();
                    const label = L.marker(center, {
                        icon: L.divIcon({
                            className: 'map-label',
                            html: escapeHtml(nameInput.value),
                            iconSize: [nameInput.value.length * 10 + 20, 30]
                        }),
                        draggable: true
                    }).addTo(map);
                    
                    // حفظ المرجع للإزالة لاحقًا
                    nameLabels[item.dataset.id] = label;
                    
                    // حدث لتحريك التسمية
                    label.on('dragend', function() {
                        // لا شيء، مجرد السماح بتحريك التسمية
                    });
                } else {
                    // إزالة الاسم من الخريطة
                    if (nameLabels[item.dataset.id]) {
                        map.removeLayer(nameLabels[item.dataset.id]);
                        delete nameLabels[item.dataset.id];
                    }
                }
            });
            
            // زيادة العداد
            selectionCounter++;
            
            // إظهار تنبيه بنجاح الإضافة
            showAlert('تمت إضافة التحديد بنجاح', 'info');
        }
        
        // تعديل التحديد
        function editSelection(id) {
            // الخروج من أي وضع رسم سابق
            resetDrawing();
            
            // العثور على العنصر المطلوب
            const item = document.querySelector(`.panel-item[data-id="${id}"]`);
            if (!item) return;
            
            // العثور على المضلع المطلوب
            const polygon = polygons.find(p => p._id === id);
            if (!polygon) return;
            
            // تمييز العنصر
            item.classList.add('edit-mode');
            
            // تمييز المضلع على الخريطة
            polygon.setStyle({weight: 4, dashArray: '5, 10'});
            
            // حفظ المضلع الأصلي
            originalPolygon = L.polygon(polygon.getLatLngs()[0], {
                color: polygon.options.color,
                fillOpacity: polygon.options.fillOpacity,
                weight: polygon.options.weight
            });
            
            // تمكين وضع التحرير
            editMode = true;
            currentEditPolygon = polygon;
            
            // استخراج النقاط من المضلع
            const latlngs = polygon.getLatLngs()[0];
            
            // إضافة علامات للنقاط
            latlngs.forEach(latlng => {
                const marker = L.marker(latlng, {
                    draggable: true
                }).addTo(map);
                
                markers.push(marker);
                
                // تحديث المضلع عند سحب العلامة
                marker.on('drag', () => {
                    const newLatLngs = markers.map(m => m.getLatLng());
                    polygon.setLatLngs([newLatLngs]);
                    calculateAreaForPolygon(polygon);
                });
            });
            
            // إظهار منبثق التعديل
            editPopup.style.display = 'block';
            calculateAreaForPolygon(polygon);
        }
        
        // تأكيد التعديل
        function confirmEdit() {
            if (!editMode) return;
            
            // إزالة العلامات
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // إعادة تعيين نمط المضلع
            if (currentEditPolygon) {
                currentEditPolygon.setStyle({weight: 2, dashArray: null});
            }
            
            // إزالة تمييز العنصر
            document.querySelectorAll('.panel-item').forEach(item => {
                item.classList.remove('edit-mode');
            });
            
            // إخفاء منبثق التعديل
            editPopup.style.display = 'none';
            
            // إعادة تعيين المتغيرات
            editMode = false;
            currentEditPolygon = null;
            originalPolygon = null;
            
            // إظهار تنبيه بنجاح التعديل
            showAlert('تم حفظ التعديلات بنجاح', 'info');
        }
        
        // التراجع عن التعديل
        function revertEdit() {
            if (!editMode) return;
            
            // إزالة العلامات
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // إعادة تعيين المضلع إلى حالته الأصلية
            if (currentEditPolygon && originalPolygon) {
                currentEditPolygon.setLatLngs(originalPolygon.getLatLngs());
                currentEditPolygon.setStyle({weight: 2, dashArray: null});
            }
            
            // إزالة تمييز العنصر
            document.querySelectorAll('.panel-item').forEach(item => {
                item.classList.remove('edit-mode');
            });
            
            // إخفاء منبثق التعديل
            editPopup.style.display = 'none';
            
            // إعادة تعيين المتغيرات
            editMode = false;
            currentEditPolygon = null;
            originalPolygon = null;
            
            // إظهار تنبيه بالتراجع عن التعديل
            showAlert('تم التراجع عن التعديلات', 'info');
        }
        
        // حساب مساحة المضلع
        function calculateAreaForPolygon(polygon) {
            try {
                const latlngs = polygon.getLatLngs()[0];
                
                // تحويل الإحداثيات إلى [lng, lat] لـ Turf.js
                const coords = latlngs.map(latlng => [latlng.lng, latlng.lat]);
                // إغلاق المضلع
                if (coords[0][0] !== coords[coords.length - 1][0] || coords[0][1] !== coords[coords.length - 1][1]) {
                    coords.push(coords[0]);
                }
                const turfPolygon = turf.polygon([coords]);
                const area = turf.area(turfPolygon);
                const areaKm = area / 1000000;
                
                areaValue.textContent = `${area.toFixed(2)} م² (${areaKm.toFixed(6)} كم²)`;
            } catch (error) {
                console.error('خطأ في حساب مساحة المضلع:', error);
                areaValue.textContent = 'خطأ في الحساب';
                showAlert('حدث خطأ أثناء حساب المساحة', 'error');
            }
        }
        
        // حذف التحديد
        function deleteSelection(id) {
            // البحث عن المضلع في المصفوفة
            const polygonIndex = polygons.findIndex(p => p._id === id);
            
            if (polygonIndex !== -1) {
                // إزالة المضلع من الخريطة
                map.removeLayer(polygons[polygonIndex]);
                polygons.splice(polygonIndex, 1);
            }
            
            // إزالة العنصر من اللوحة
            const item = document.querySelector(`.panel-item[data-id="${id}"]`);
            if (item) item.remove();
            
            // إزالة الاسم المرتبط إذا كان موجودًا
            if (nameLabels[id]) {
                map.removeLayer(nameLabels[id]);
                delete nameLabels[id];
            }
            
            // إذا لم يعد هناك تحديدات، عرض رسالة
            if (document.querySelectorAll('.panel-item').length === 0) {
                const container = document.getElementById('current-selections');
                container.innerHTML = '<div class="no-selections">لا توجد تحديدات حتى الآن</div>';
            }
            
            // إظهار تنبيه بالحذف
            showAlert('تم حذف التحديد بنجاح', 'info');
        }
        
        // إضافة نص إلى الخريطة
        function addText() {
            const center = map.getCenter();
            
            const label = L.divIcon({
                className: 'map-label',
                html: '<div style="color: #000000;">نص جديد</div>',
                iconSize: [100, 30]
            });
            
            const marker = L.marker(center, {
                icon: label,
                draggable: true
            }).addTo(map);
            
            // إعطاء معرف فريد للنص
            marker._id = `text-${Date.now()}`;
            labels.push(marker);
            
            // إضافة التحديد إلى اللوحة
            addTextToSelections(marker);
        }
        
        // إضافة نص إلى لوحة التحديدات
        function addTextToSelections(marker) {
            const container = document.getElementById('current-selections');
            const noSelections = container.querySelector('.no-selections');
            
            if (noSelections) {
                noSelections.remove();
            }
            
            const item = document.createElement('div');
            item.className = 'panel-item';
            item.dataset.id = marker._id;
            
            item.innerHTML = `
                <div class="panel-item-title">
                    <input type="text" value="نص ${selectionCounter}" class="selection-name">
                    <i class="fas fa-font"></i>
                </div>
                
                <div class="panel-item-content">
                    <input type="text" value="نص جديد" class="text-content">
                    <div class="selection-option">
                        <span>لون النص:</span>
                        <input type="color" class="text-color" value="#000000">
                    </div>
                </div>
                
                <div class="item-actions">
                    <button class="action-btn delete-btn" data-id="${marker._id}">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
            `;
            
            container.appendChild(item);
            
            // إضافة أحداث للأزرار
            const deleteBtn = item.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', () => {
                map.removeLayer(marker);
                labels = labels.filter(l => l._id !== marker._id);
                item.remove();
                
                if (document.querySelectorAll('.panel-item').length === 0) {
                    const container = document.getElementById('current-selections');
                    container.innerHTML = '<div class="no-selections">لا توجد تحديدات حتى الآن</div>';
                }
                
                showAlert('تم حذف النص بنجاح', 'info');
            });
            
            // تحديث النص عند التعديل
            const textInput = item.querySelector('.text-content');
            textInput.addEventListener('input', function() {
                const color = item.querySelector('.text-color').value;
                marker.setIcon(L.divIcon({
                    className: 'map-label',
                    html: `<div style="color: ${color};">${escapeHtml(this.value)}</div>`,
                    iconSize: [this.value.length * 10 + 20, 30]
                }));
            });
            
            // تحديث لون النص
            const colorInput = item.querySelector('.text-color');
            colorInput.addEventListener('input', function() {
                const text = item.querySelector('.text-content').value;
                marker.setIcon(L.divIcon({
                    className: 'map-label',
                    html: `<div style="color: ${this.value};">${escapeHtml(text)}</div>`,
                    iconSize: [text.length * 10 + 20, 30]
                }));
            });
            
            // تحديث اسم التحديد
            const nameInput = item.querySelector('.selection-name');
            nameInput.addEventListener('input', function() {
                // يمكن إضافة وظائف إضافية هنا
            });
            
            selectionCounter++;
            
            // إظهار تنبيه بنجاح الإضافة
            showAlert('تمت إضافة النص بنجاح', 'info');
        }
        
        // إضافة رمز إلى الخريطة
        function addIcon(type) {
            const center = map.getCenter();
            
            let iconUrl, title;
            if (type === 'fire') {
                iconUrl = "ملصقات/دبابة.png";
                title = 'نار تشتعل';
            } else if (type === 'soldier') {
                iconUrl = "ملصقات/جنود.png";
                title = 'جندي';
            } else {
                iconUrl = "ملصقات/طيارة.png";
                title = 'طائرة';
            }
            
            const icon = L.icon({
                iconUrl: iconUrl,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            const marker = L.marker(center, {
                icon: icon,
                draggable: true
            }).addTo(map);
            
            // إعطاء معرف فريد للأيقونة
            marker._id = `icon-${Date.now()}`;
            marker._type = type;
            icons.push(marker);
            
            // إضافة التحديد إلى اللوحة
            addIconToSelections(marker, title);
        }
        
        // إضافة رمز إلى لوحة التحديدات
        function addIconToSelections(marker, title) {
            const container = document.getElementById('current-selections');
            const noSelections = container.querySelector('.no-selections');
            
            if (noSelections) {
                noSelections.remove();
            }
            
            const item = document.createElement('div');
            item.className = 'panel-item';
            item.dataset.id = marker._id;
            
            item.innerHTML = `
                <div class="panel-item-title">
                    <span>${title} ${selectionCounter}</span>
                    <img src="${marker.options.icon.options.iconUrl}" width="24" height="24">
                </div>
                
                <div class="item-actions">
                    <button class="action-btn delete-btn" data-id="${marker._id}">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
            `;
            
            container.appendChild(item);
            
            // إضافة أحداث للأزرار
            const deleteBtn = item.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', () => {
                map.removeLayer(marker);
                icons = icons.filter(i => i._id !== marker._id);
                item.remove();
                
                if (document.querySelectorAll('.panel-item').length === 0) {
                    const container = document.getElementById('current-selections');
                    container.innerHTML = '<div class="no-selections">لا توجد تحديدات حتى الآن</div>';
                }
                
                showAlert('تم حذف الأيقونة بنجاح', 'info');
            });
            
            selectionCounter++;
            
            // إظهار تنبيه بنجاح الإضافة
            showAlert('تمت إضافة الأيقونة بنجاح', 'info');
        }
        
        // البحث عن موقع
        function searchLocation(query) {
            if (!query.trim()) {
                showAlert('يرجى إدخال استعلام بحث', 'error');
                return;
            }
            
            if (!geoJsonData) {
                showAlert('بيانات المواقع غير متوفرة حالياً', 'error');
                return;
            }
            
            // تنظيف الإدخال لمنع XSS
            const normalizedQuery = escapeHtml(query.trim().toLowerCase());
            
            // إزالة نتائج البحث السابقة
            if (lastSearchPolygon) {
                map.removeLayer(lastSearchPolygon);
                lastSearchPolygon = null;
            }
            if (lastSearchLabel) {
                map.removeLayer(lastSearchLabel);
                lastSearchLabel = null;
            }
            currentSearchResult = null; // إعادة تعيين نتيجة البحث
            
            let found = false;
            
            // البحث في بيانات GeoJSON
            try {
                geoJsonData.features.forEach(feature => {
                    const name = feature.properties.name.toLowerCase();
                    
                    if (name.includes(normalizedQuery)) {
                        found = true;
                        
                        // إنشاء مضلع للموقع
                        const coords = feature.geometry.coordinates[0].map(coord => [coord[1], coord[0]]);
                        const polygon = L.polygon(coords, {
                            color: '#00ff00',
                            fillOpacity: 0.3,
                            weight: 2
                        }).addTo(map);
                        
                        // إعطاء معرف فريد للمضلع
                        polygon._id = `search-result-${Date.now()}`;
                        
                        // إضافة تسمية في المركز
                        const center = polygon.getBounds().getCenter();
                        const label = L.marker(center, {
                            icon: L.divIcon({
                                className: 'map-label',
                                html: escapeHtml(feature.properties.name),
                                iconSize: [120, 30]
                            })
                        }).addTo(map);
                        
                        // ضبط الخريطة لتناسب المنطقة
                        map.fitBounds(polygon.getBounds());
                        
                        // حفظ المرجع
                        lastSearchPolygon = polygon;
                        lastSearchLabel = label;
                        currentSearchResult = {
                            polygon: polygon,
                            label: label,
                            name: feature.properties.name,
                            id: polygon._id
                        };
                        
                        // عرض منبثق البحث
                        document.getElementById('modal-city-name').textContent = `تم العثور على: ${escapeHtml(feature.properties.name)}`;
                        document.getElementById('search-modal').style.display = 'block';
                    }
                });
                
                if (!found) {
                    showAlert('لم يتم العثور على الموقع المطلوب', 'error');
                }
            } catch (error) {
                console.error('خطأ في البحث:', error);
                showAlert('حدث خطأ أثناء البحث عن الموقع', 'error');
            }
        }
        
        // إضافة نتيجة البحث إلى التحديدات
        function addSearchResultToSelections() {
            if (!currentSearchResult || !currentSearchResult.polygon) {
                showAlert('لا توجد نتيجة بحث صالحة لإضافتها', 'error');
                document.getElementById('search-modal').style.display = 'none';
                return;
            }
            
            // تغيير لون المضلع من الأخضر إلى اللون العشوائي
            const color = getRandomColor();
            currentSearchResult.polygon.setStyle({
                color: color,
                fillColor: color
            });
            
            // إضافة المضلع إلى التحديدات
            polygons.push(currentSearchResult.polygon);
            
            // إضافة التحديد إلى اللوحة
            const container = document.getElementById('current-selections');
            const noSelections = container.querySelector('.no-selections');
            
            if (noSelections) {
                noSelections.remove();
            }
            
            const item = document.createElement('div');
            item.className = 'panel-item';
            item.dataset.id = currentSearchResult.id;
            
            item.innerHTML = `
                <div class="panel-item-title">
                    <input type="text" value="${escapeHtml(currentSearchResult.name)}" class="selection-name">
                    <input type="color" class="shape-color" value="${color}">
                </div>
                
                <div class="panel-item-content">
                    <div class="selection-option">
                        <input type="checkbox" id="show-name-${currentSearchResult.id}" class="show-name" checked>
                        <label for="show-name-${currentSearchResult.id}">إظهار الاسم على الخريطة</label>
                    </div>
                    
                    <div class="style-control">
                        <label>الشفافية:</label>
                        <input type="range" min="0" max="1" step="0.1" class="opacity-slider" value="0.3">
                    </div>
                    
                    <div class="selection-info">
                        <p><strong>المدينة:</strong> ${escapeHtml(currentSearchResult.name)}</p>
                    </div>
                </div>
                
                <div class="item-actions">
                    <button class="action-btn edit-btn" data-id="${currentSearchResult.id}">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button class="action-btn delete-btn" data-id="${currentSearchResult.id}">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
            `;
            
            container.appendChild(item);
            
            // إضافة أحداث للأزرار
            const editBtn = item.querySelector('.edit-btn');
            const deleteBtn = item.querySelector('.delete-btn');
            editBtn.addEventListener('click', () => editSelection(editBtn.dataset.id));
            deleteBtn.addEventListener('click', () => deleteSelection(deleteBtn.dataset.id));
            
            // إضافة حدث لتغيير اللون
            const colorInput = item.querySelector('.shape-color');
            colorInput.addEventListener('input', function() {
                currentSearchResult.polygon.setStyle({fillColor: this.value, color: this.value});
            });
            
            // إضافة حدث لتغيير الشفافية
            const opacitySlider = item.querySelector('.opacity-slider');
            opacitySlider.addEventListener('input', function() {
                currentSearchResult.polygon.setStyle({fillOpacity: this.value});
            });
            
            // إضافة حدث لإظهار/إخفاء الاسم
            const nameCheckbox = item.querySelector('.show-name');
            nameCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    if (!currentSearchResult.label) {
                        const center = currentSearchResult.polygon.getBounds().getCenter();
                        currentSearchResult.label = L.marker(center, {
                            icon: L.divIcon({
                                className: 'map-label',
                                html: escapeHtml(currentSearchResult.name),
                                iconSize: [120, 30]
                            })
                        }).addTo(map);
                    }
                } else {
                    if (currentSearchResult.label) {
                        map.removeLayer(currentSearchResult.label);
                        currentSearchResult.label = null;
                    }
                }
            });
            
            // إخفاء منبثق البحث
            document.getElementById('search-modal').style.display = 'none';
            
            // إعادة تعيين نتيجة البحث
            lastSearchPolygon = null;
            lastSearchLabel = null;
            currentSearchResult = null;
            
            // زيادة العداد
            selectionCounter++;
            
            // إظهار تنبيه بنجاح الإضافة
            showAlert('تمت إضافة نتيجة البحث إلى التحديدات', 'info');
        }
        
        // إلغاء نتيجة البحث
        function cancelSearchResult() {
            if (lastSearchPolygon) {
                map.removeLayer(lastSearchPolygon);
                lastSearchPolygon = null;
            }
            if (lastSearchLabel) {
                map.removeLayer(lastSearchLabel);
                lastSearchLabel = null;
            }
            document.getElementById('search-modal').style.display = 'none';
            currentSearchResult = null;
        }
        
        // حذف جميع العناصر
        function deleteAllItems() {
            if (polygons.length === 0 && labels.length === 0 && icons.length === 0) {
                showAlert('لا توجد عناصر للحذف', 'info');
                return;
            }
            
            // تأكيد الحذف
           /* if (!confirm('هل أنت متأكد من حذف جميع التحديدات؟')) {
                return;
            }*/
            
            // حذف جميع العلامات من الخريطة
            markers.forEach(marker => map.removeLayer(marker));
            polygons.forEach(polygon => {
                polygon.off();
                map.removeLayer(polygon);
            });
            labels.forEach(label => map.removeLayer(label));
            icons.forEach(icon => map.removeLayer(icon));
            
            // إفراغ المصفوفات
            markers = [];
            polygons = [];
            labels = [];
            icons = [];
            
            // إعادة تعيين الحالة
            resetDrawing();
            
            // تحديث اللوحة
            const container = document.getElementById('current-selections');
            container.innerHTML = '<div class="no-selections">لا توجد تحديدات حتى الآن</div>';
            
            // إزالة جميع الأسماء
            Object.values(nameLabels).forEach(label => map.removeLayer(label));
            nameLabels = {};
            
            // إعادة تعيين العداد
            selectionCounter = 1;
            
            // إظهار تنبيه بالحذف
            showAlert('تم حذف جميع التحديدات بنجاح', 'info');
        }
        
        // تبديل الوضع الداكن/الفاتح
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const themeIcon = document.querySelector('#theme-toggle i');
            
            if (document.body.classList.contains('dark-mode')) {
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }
        
        // تحديث الوضع بناءً على تفضيلات المستخدم
        function updateThemeBasedOnPreference() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark-mode');
                document.querySelector('#theme-toggle i').className = 'fas fa-sun';
            } else {
                document.body.classList.remove('dark-mode');
                document.querySelector('#theme-toggle i').className = 'fas fa-moon';
            }
        }
        
        // إعادة تعيين عملية الرسم
        function resetDrawing() {
            // إزالة المستمعات
            map.off('click', handleMapClick);
            
            // الخروج من وضع التحرير
            if (editMode) {
                exitEditMode();
            }
            
            // إخفاء صندوق المساحة
            currentAreaBox.style.display = 'none';
            
            // إزالة العلامات المؤقتة
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // إزالة الطبقة المؤقتة
            if (currentLayer && !polygons.includes(currentLayer)) {
                map.removeLayer(currentLayer);
            }
            currentLayer = null;
            
            // إعادة تعيين وضع الرسم
            drawingMode = null;
        }
        
        // إنشاء لون عشوائي
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
        
        // دالة لتنظيف الإدخال لمنع XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // الخروج من وضع التحرير
        function exitEditMode() {
            if (!editMode) return;
            
            // إزالة العلامات
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // إعادة تعيين نمط المضلع
            if (currentEditPolygon) {
                currentEditPolygon.setStyle({weight: 2, dashArray: null});
            }
            
            // إزالة تمييز العنصر
            document.querySelectorAll('.panel-item').forEach(item => {
                item.classList.remove('edit-mode');
            });
            
            // إخفاء منبثق التعديل
            editPopup.style.display = 'none';
            
            // إعادة تعيين المتغيرات
            editMode = false;
            currentEditPolygon = null;
            originalPolygon = null;
        }
        
        // عرض رسالة تنبيه
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        // تهيئة الخريطة عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
